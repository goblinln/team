!function(x){var c={},g=null;function t(e){g.children().remove();var s=x.extend(!0,{showWeekends:!0,cellWidth:40,cellHeight:30,vtHeaderWidth:200,data:[],dataUrl:null,behavior:{clickable:!0,resizable:!0}},e);function t(){for(var e=0;e<s.data.length;e++)for(var t=0;t<s.data[e].series.length;t++){var a=s.data[e].series[t];a.start&&a.end&&(a.start=new Date(a.start),a.end=new Date(a.end))}var i=Math.floor((g.outerWidth()-s.vtHeaderWidth)/s.cellWidth+15),n=m.getBoundaryDatesFromData(s.data,i);s.start=n[0],s.end=n[1],g.each(function(){var e=x(this),t=x("<div>",{class:"ganttview"});new r(t,s).render(),e.append(t),new d(e,s).apply()})}x.extend(c,s),s.data?t():s.dataUrl&&x.getJSON(s.dataUrl,function(e){s.data=e,x.extend(c,s),t()})}x.fn.resizeEnd=function(t,a){$(this).resize(function(){var e=$(this);e.data("resizeTimeout")&&clearTimeout(e.data("resizeTimeout")),e.data("resizeTimeout",setTimeout(t,a))})},x.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]?t.call(g=this,e[0]):1<=e.length&&(e[0],1)&&function(e){if(1<e.length&&"getDatas"===e[0]&&"function"==typeof e[1]){var a=[];c.data.forEach(function(e){var t={};x.extend(t,e),t.series=e.series.filter(function(e){return!e._empty}),a.push(t)}),e[1](a)}}.call(g,e),$(window).resizeEnd(function(){t.call(g,c)},500)};var r=function(i,n){var g=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];return{render:function(){!function(e,t,a,i){var n=x("<div>",{class:"ganttview-vtheader",css:{width:i+"px"}}),s=x("<div>",{class:"ganttview-vtheader-title",css:{width:i+"px",height:2*a+1+"px"}});s.append(x("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+1+"px",width:"80px"}}).append("指派人")),s.append(x("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+1+"px",width:"calc(100% - 162px)"}}).append("任务")),s.append(x("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+1+"px",width:"80px"}}).append("测试人员")),n.append(s);for(var r=0;r<t.length;r++){t[r].series&&0!==t[r].series.length||(t[r].series=[{id:null,name:"暂无任务",_empty:!0}]);var d=x("<div>",{class:"ganttview-vtheader-item",css:{height:t[r].series.length*a+1+"px"}});d.append(x("<div>",{class:"ganttview-vtheader-item-name",css:{height:t[r].series.length*a+1+"px","line-height":t[r].series.length*a-6+"px"}}).append(t[r].name));for(var l=x("<div>",{class:"ganttview-vtheader-series"}),o=0;o<t[r].series.length;o++){var h=x("<div>",{class:"ganttview-vtheader-series-item",css:{height:a+"px"}});h.append(x("<div>",{class:"ganttview-vtheader-series-name",css:{height:a+"px"}}).append(t[r].series[o].name)),h.append(x("<div>",{class:"ganttview-vtheader-series-cooperator",css:{height:a+"px"}}).append(t[r].series[o].cooperator||"")),l.append(h)}d.append(l),n.append(d)}e.append(n)}(i,n.data,n.cellHeight,n.vtHeaderWidth);var e,t=x("<div>",{class:"ganttview-slide-container"}),a=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];for(var i=e;i.getTime()<t.getTime();){var n=m.addDays(new Date(i),1);a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(n.start,n.end);!function(e,t,a,i){var n=x("<div>",{class:"ganttview-hzheader"}),s=x("<div>",{class:"ganttview-hzheader-months clearfix"}),r=x("<div>",{class:"ganttview-hzheader-days clearfix"}),d=0;for(var l in t)for(var o in t[l]){var h=t[l][o].length*a;for(var v in d+=h,s.append(x("<div>",{class:"ganttview-hzheader-month",css:{width:h-1+"px"}}).append(l+"年"+g[o])),t[l][o]){var c=x("<div>",{class:"ganttview-hzheader-day",css:{width:a-1+"px"}});c.append(t[l][o][v].getDate()),m.isWeekend(t[l][o][v])&&i&&c.addClass("ganttview-weekend"),r.append(c)}}s.css("width",d+"px"),r.css("width",d+"px"),n.append(s).append(r),e.append(n)}(t,a,n.cellWidth,n.showWeekends),function(e,t,a,i,n,s){var r=x("<div>",{class:"ganttview-grid"}),d=x("<div>",{class:"ganttview-grid-row clearfix"});for(var l in a)for(var o in a[l])for(var h in a[l][o]){var v=x("<div>",{class:"ganttview-grid-row-cell",css:{width:i-1+"px",height:n-1+"px"}});m.isWeekend(a[l][o][h])&&s&&v.addClass("ganttview-weekend"),d.append(v)}var c=x("div.ganttview-grid-row-cell",d).length*i;d.css("width",c+"px"),r.css("width",c+"px");for(var g=0;g<t.length;g++)for(var p=0;p<t[g].series.length;p++){var w=d.clone();r.append(w)}e.append(r)}(t,n.data,a,n.cellWidth,n.cellHeight,n.showWeekends),function(e,t,a){for(var i=x("<div>",{class:"ganttview-blocks"}),n=0;n<t.length;n++)for(var s=0;s<t[n].series.length;s++)i.append(x("<div>",{class:"ganttview-block-container",css:{height:a-8+"px"}}));e.append(i)}(t,n.data,n.cellHeight),function(e,t,a,i,n){for(var s=x("div.ganttview-blocks div.ganttview-block-container",e),r=0,d=0;d<t.length;d++)for(var l=0;l<t[d].series.length;l++){var o=t[d].series[l],h=0;if(!o._empty){h=m.daysBetween(o.start,o.end)+1;var v=m.daysBetween(i,o.start),c=x("<div>",{class:"ganttview-block",title:o.name+"： "+h+" 天",css:{width:h*a-8+"px",height:n-8+"px","margin-left":v*a+4+"px"}});g=c,p=t[d],w=o,f={resizable:!(u=void 0)},u={id:p.id,taskId:null,name:p.name},w.options&&x.extend(f,w.options),x.extend(u,w),u.options=f,g.data("block-data",u),t[d].series[l].options&&t[d].series[l].options.color&&c.css("background-color",t[d].series[l].options.color),c.append(x("<div>",{class:"ganttview-block-text",css:{height:n-8+"px","line-height":n-8+"px"}}).text(h+"天")),x(s[r]).append(c)}r+=1}var g,p,w,f,u}(t,n.data,n.cellWidth,n.start,n.cellHeight),i.append(t),e=i.parent(),x("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",e).addClass("last"),x("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",e).addClass("last"),x("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",e).addClass("last")}}},d=function(r,d){return{apply:function(){var e,t,a,i,n,s;d.behavior.clickable&&(e=r,t=d.behavior.onClick,x("div.ganttview-block",e).on("click",function(){t&&t(x(this).data("block-data"))})),d.behavior.resizable&&(a=r,i=d.cellWidth,n=d.start,s=d.behavior.onResize,x("div.ganttview-block",a).each(function(){x(this).data("block-data").options.resizable&&x(this).resizable({handles:"e",stop:function(){var e=x(this),t=(e.outerWidth()+8)%i<i/2?Math.floor((e.outerWidth()+8)/i):Math.ceil((e.outerWidth()+8)/i);e.width(t*i-8),function(e,t,a,i){var n=x("div.ganttview-slide-container",e),s=n.scrollLeft(),r=t.offset().left-n.offset().left-1+s,d=Math.floor(r/a),l=m.addDays(new Date(i),d);t.data("block-data").start=l;var o=t.outerWidth(),h=Math.floor(o/a),v=m.addDays(new Date(l),h);t.data("block-data").end=v,x("div.ganttview-block-text",t).text(h+1+"天"),t.css("top","").css("left","").css("position","relative"),function(e,t,a){for(var i=g.find(".ganttview-block").index(e),n=0,s=0;s<c.data.length;s++)for(var r=0;r<c.data[s].series.length;r++)if(!c.data[s].series[r]._empty){if(n===i)return console.log(c.data[s].series[r]),c.data[s].series[r].start=t,c.data[s].series[r].end=a;n++}}(t,l,v)}(a,e,i,n),s&&s(e.data("block-data"))}})}))}}},m={addDays:function(e,t){return new Date(e.getTime()+864e5*t)},daysBetween:function(e,t){if(!e||!t)return 0;if(1901===new Date(e).getFullYear()||8099===new Date(t).getFullYear())return 0;for(var a=0,i=new Date(e);i.getTime()<new Date(t).getTime();)a+=1,i=m.addDays(i,1);return a},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){for(var a=m.addDays(new Date,-15),i=new Date,n=0;n<e.length;n++)for(var s=0;s<e[n].series.length;s++)if(e[n].series[s].start&&e[n].series[s].end){var r=new Date(e[n].series[s].start),d=new Date(e[n].series[s].end);0==n&&0==s&&(a=new Date(r),i=new Date(d)),a.getTime()>r.getTime()&&(a=new Date(r)),i.getTime()<d.getTime()&&(i=new Date(d))}return m.daysBetween(a,i)<t&&(i=m.addDays(a,t)),[a,i]}}}(jQuery);