!function(y){var v={},p=null;function t(e){p.children().remove();var r=y.extend(!0,{showWeekends:!0,cellWidth:40,cellHeight:30,vtHeaderWidth:200,data:[],dataUrl:null,holidays:[],behavior:{clickable:!0,resizable:!0}},e);function t(){for(var e=0;e<r.data.length;e++)for(var t=0;t<r.data[e].series.length;t++){var a=r.data[e].series[t];a.start&&a.end&&(a.start=new Date(a.start),a.end=new Date(a.end))}for(e=0;e<r.holidays.length;e++){var i=r.holidays[e];i.start=new Date(i.start).getTime(),i.end=new Date(i.end).getTime()}var n=Math.floor((p.outerWidth()-r.vtHeaderWidth)/r.cellWidth+15),s=D.getBoundaryDatesFromData(r.data,n);r.start=s[0],r.end=s[1],p.each(function(){var e=y(this),t=y("<div>",{class:"ganttview"});new d(t,r).render(),e.append(t),new l(e,r).apply()})}y.extend(v,r),r.data?t():r.dataUrl&&y.getJSON(r.dataUrl,function(e){r.data=e,y.extend(v,r),t()})}y.fn.resizeEnd=function(t,a){$(this).resize(function(){var e=$(this);e.data("resizeTimeout")&&clearTimeout(e.data("resizeTimeout")),e.data("resizeTimeout",setTimeout(t,a))})},y.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]?t.call(p=this,e[0]):1<=e.length&&(e[0],1)&&function(e){if(1<e.length&&"getDatas"===e[0]&&"function"==typeof e[1]){var a=[];v.data.forEach(function(e){var t={};y.extend(t,e),t.series=e.series.filter(function(e){return!e._empty}),a.push(t)}),e[1](a)}}.call(p,e),$(window).resizeEnd(function(){t.call(p,v)},500)};var d=function(i,m){var p=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];return{render:function(){!function(e,t,a,i){var n=y("<div>",{class:"ganttview-vtheader",css:{width:i+"px"}}),s=y("<div>",{class:"ganttview-vtheader-title",css:{width:i+"px",height:2*a+1+"px"}});s.append(y("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+"px",width:"80px"}}).append("开发人员")),s.append(y("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+"px",width:"calc(100% - 243px)"}}).append("任务")),s.append(y("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+"px",width:"80px"}}).append("发布人员")),s.append(y("<div>",{class:"ganttview-vtheader-title-name",css:{height:"100%","line-height":2*a+"px",width:"80px"}}).append("测试人员")),n.append(s);for(var r=0;r<t.length;r++){t[r].series&&0!==t[r].series.length||(t[r].series=[{id:null,name:"暂无任务",_empty:!0}]);var d=t[r].series.length*a,l=y("<div>",{class:"ganttview-vtheader-item",css:{height:d+"px"}});l.append(y("<div>",{class:"ganttview-vtheader-item-name",css:{height:d+"px","line-height":t[r].series.length*a-6+"px"}}).append(t[r].name));for(var o=y("<div>",{class:"ganttview-vtheader-series"}),h=0;h<t[r].series.length;h++){var c=y("<div>",{class:"ganttview-vtheader-series-item",css:{height:a-1+"px"}});c.append(y("<div>",{class:"ganttview-vtheader-series-name",css:{height:a-1+"px"}}).append(t[r].series[h].name)),c.append(y("<div>",{class:"ganttview-vtheader-series-creator",css:{height:a-1+"px"}}).append(t[r].series[h].creator||"")),c.append(y("<div>",{class:"ganttview-vtheader-series-cooperator",css:{height:a-1+"px"}}).append(t[r].series[h].cooperator||"")),o.append(c)}l.append(o),n.append(l)}e.append(n)}(i,m.data,m.cellHeight,m.vtHeaderWidth);var e,t=y("<div>",{class:"ganttview-slide-container"}),a=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];for(var i=e;i.getTime()<t.getTime();){var n=D.addDays(new Date(i),1);a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(m.start,m.end);!function(e,t,a,i){var n=y("<div>",{class:"ganttview-hzheader"}),s=y("<div>",{class:"ganttview-hzheader-months clearfix"}),r=y("<div>",{class:"ganttview-hzheader-days clearfix"}),d=0;for(var l in t)for(var o in t[l]){var h=t[l][o].length*a;for(var c in d+=h,s.append(y("<div>",{class:"ganttview-hzheader-month",css:{width:h-1+"px"}}).append(l+"年"+p[o])),t[l][o]){var v=y("<div>",{class:"ganttview-hzheader-day",css:{width:a-1+"px"}});v.append(t[l][o][c].getDate()),D.isWeekend(t[l][o][c],m.holidays)&&i&&v.addClass("ganttview-weekend"),r.append(v)}}s.css("width",d+"px"),r.css("width",d+"px"),n.append(s).append(r),e.append(n)}(t,a,m.cellWidth,m.showWeekends),function(e,t,a,i,n,s){var r=y("<div>",{class:"ganttview-grid"}),d=y("<div>",{class:"ganttview-grid-row clearfix"});for(var l in a)for(var o in a[l])for(var h in a[l][o]){var c=y("<div>",{class:"ganttview-grid-row-cell",css:{width:i-1+"px",height:n-1+"px"}});D.isWeekend(a[l][o][h],m.holidays)&&s&&c.addClass("ganttview-weekend"),d.append(c)}var v=y("div.ganttview-grid-row-cell",d).length*i;d.css("width",v+"px"),r.css("width",v+"px");for(var p=0;p<t.length;p++)for(var g=0;g<t[p].series.length;g++){var w=d.clone();r.append(w)}e.append(r)}(t,m.data,a,m.cellWidth,m.cellHeight,m.showWeekends),function(e,t,a){for(var i=y("<div>",{class:"ganttview-blocks"}),n=0;n<t.length;n++)for(var s=0;s<t[n].series.length;s++)i.append(y("<div>",{class:"ganttview-block-container",css:{height:a-8+"px"}}));e.append(i)}(t,m.data,m.cellHeight),function(e,t,a,i,n){for(var s=y("div.ganttview-blocks div.ganttview-block-container",e),r=0,d=0;d<t.length;d++)for(var l=0;l<t[d].series.length;l++){var o=t[d].series[l],h=0;if(!o._empty){h=D.daysBetween(o.start,o.end)+1;var c=D.daysBetween(i,o.start),v=y("<div>",{class:"ganttview-block",title:o.name+"： "+h+" 天/"+D.calcWorkDays(o.start,o.end,m.holidays)+" 工作日",css:{width:h*a-8+"px",height:n-8+"px","margin-left":c*a+4+"px"}});g=v,w=t[d],f=o,u={resizable:!(x=void 0)},x={id:w.id,taskId:null,name:w.name},f.options&&y.extend(u,f.options),y.extend(x,f),x.options=u,g.data("block-data",x),t[d].series[l].options&&t[d].series[l].options.color&&v.css("background-color",t[d].series[l].options.color);var p=y("<div>",{class:"ganttview-block-text",css:{height:n-8+"px","line-height":n-8+"px"}});t[d].series[l].is_delayed?(p.append(y("<i>",{class:"fa fa-exclamation-circle text-danger mr-1"})),p.append(h+"天")):p.text(h+"天"),v.append(p),y(s[r]).append(v)}r+=1}var g,w,f,u,x}(t,m.data,m.cellWidth,m.start,m.cellHeight),i.append(t),e=i.parent(),y("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",e).addClass("last"),y("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",e).addClass("last"),y("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",e).addClass("last")}}},l=function(r,d){return{apply:function(){var e,t,a,i,n,s;d.behavior.clickable&&(e=r,t=d.behavior.onClick,y("div.ganttview-block",e).on("click",function(){t&&t(y(this).data("block-data"))})),d.behavior.resizable&&(a=r,i=d.cellWidth,n=d.start,s=d.behavior.onResize,y("div.ganttview-block",a).each(function(){y(this).data("block-data").options.resizable&&y(this).resizable({handles:"e",stop:function(){var e=y(this),t=(e.outerWidth()+8)%i<i/2?Math.floor((e.outerWidth()+8)/i):Math.ceil((e.outerWidth()+8)/i);e.width(t*i-8),function(e,t,a,i){var n=y("div.ganttview-slide-container",e),s=n.scrollLeft(),r=t.offset().left-n.offset().left-1+s,d=Math.floor(r/a),l=D.addDays(new Date(i),d);t.data("block-data").start=l;var o=t.outerWidth(),h=Math.floor(o/a),c=D.addDays(new Date(l),h);t.data("block-data").end=c,y("div.ganttview-block-text",t).text(h+1+"天"),t.css("top","").css("left","").css("position","relative"),function(e,t,a){for(var i=p.find(".ganttview-block").index(e),n=0,s=0;s<v.data.length;s++)for(var r=0;r<v.data[s].series.length;r++)if(!v.data[s].series[r]._empty){if(n===i)return console.log(v.data[s].series[r]),v.data[s].series[r].start=t,v.data[s].series[r].end=a;n++}}(t,l,c)}(a,e,i,n),s&&s(e.data("block-data"))}})}))}}},D={addDays:function(e,t){return new Date(e.getTime()+864e5*t)},daysBetween:function(e,t){if(!e||!t)return 0;if(1901===new Date(e).getFullYear()||8099===new Date(t).getFullYear())return 0;for(var a=0,i=new Date(e);i.getTime()<new Date(t).getTime();)a+=1,i=D.addDays(i,1);return a},isWeekend:function(e,t){if(0==e.getDay())return!0;for(var a=0;a<t.length;a++){var i=e.getTime(),n=t[a];if(i>=n.start&&i<=n.end)return!0}return!1},calcWorkDays:function(e,t,a){for(var i=new Date(e),n=new Date(t),s=i,r=0;s<=n;)this.isWeekend(s,a)||r++,s=D.addDays(s,1);return r},getBoundaryDatesFromData:function(e,t){for(var a=D.addDays(new Date,-15),i=new Date,n=0;n<e.length;n++)for(var s=0;s<e[n].series.length;s++)if(e[n].series[s].start&&e[n].series[s].end){var r=new Date(e[n].series[s].start),d=new Date(e[n].series[s].end);0==n&&0==s&&(a=new Date(r),i=new Date(d)),a.getTime()>r.getTime()&&(a=new Date(r)),i.getTime()<d.getTime()&&(i=new Date(d))}return D.daysBetween(a,i)<t&&(i=D.addDays(a,t)),[a,i]}}}(jQuery);